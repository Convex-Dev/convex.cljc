;;
;;
;; Testing `convex.shell.code`.
;;
;;


;;;;;;;;;;


(def T
     $.test)


;;;;;;;;;; Test suites


(defn suite.decompile

  ^{:doc {:description "Experimental decompilation"}}

  []

  (T/group '((T/path.conj 'decompile)

             ($.code/!.decompile (fn [x] x))
             (T/trx '(= '(fn [x] %0)
                        $/*result*)
                    {:description "Function."})

             ($.code/!.decompile (compile '(+ 2 2)))
             (T/trx `(= $/*result*
                        '((lookup ~*address* +) 2 2))
                    {:description "Compiled op."}))))



(defn suite.gensym

  ^{:doc {:description "Generating hygenic symbols."}}

  []

  (T/group '((T/path.conj 'gensym)

             (T/trx '(symbol? ($.code/gensym))
                    {:description "Result is a symbol."})

             (T/trx '(not (= ($.code/gensym)
                             ($.code/gensym)))
                    {:description "Results should be unique."})

             (T/trx '(not (= ($.code/gensym "foo")
                             ($.code/gensym "foo")))
                    {:description "Results should be unique even with a prefix."})

             (T/trx '(let [s (str ($.code/gensym "foo"))]
                       (= (str (nth s 0)
                               (nth s 1)
                               (nth s 2))
                          "foo"))
                    {:description "Prefix is correctly applied."}))))



(defn suite.read+

  ^{:doc {:description "Convex Lisp reader."}}

  []

  (T/group '((T/path.conj 'read)

             (def a
                  '(+ 2 2))

             (def b
                  '(fn [x] (inc x)))

             ($.code/!.read+ (str a
                                  b))

             (T/trx '(= '((+ 2 2)
                          (fn [x] (inc x)))
                        $/*result*)))))

;;;


(defn suite.main

  []

  (T/group '((T/path.conj 'convex.shell.code)
             (suite.decompile)
             (suite.gensym)
             (suite.read+))))


;;;


(suite.main)
(T/print "convex.shell.code")

;;
;;
;; Testing `convex.shell.time`.
;;
;;


;;;;;;;;;; Importing libraries


(def T
     $.test)


;;;;;;;;;; Test suites


(defn suite.advance

  ^{:doc {:description "Advancing time."}}

  []

  (T/group '((T/path.conj 'advance)

             (def interval
                  100)

             (def start
                  *timestamp*)

             (def end
                  (+ start
                     interval))

             (schedule (+ start
                          interval)
                       (def foo
                            42))

             (T/trx '($.trx/precat '(($.time/!.advance (dec interval))
                                     (= (dec interval)
                                         $/*result*)))
                    {:description "Advancing time returns given interval."})

             (T/trx '(not (defined? foo))
                    {:description "Scheduled transaction not yet executed."})

             (T/trx '(= (- end
                           1)
                        *timestamp*)
                    {:description "Clock advanced precisely as expected."})

             (T/trx '($.trx/precat '(($.time/!.advance 1)
                                     (= foo
                                        42)))
                    {:description "Scheduled transaction executed."})

             (T/trx '(= end
                        *timestamp*)
                    {:description "Timestamp precisely where expected."}))))



(defn suite.unix

  ^{:doc {:description "Unix timestamps."}}

  []

  (T/group '((T/path.conj 'unix)

             ($.time/!.unix)
             (def unix-timestamp
                  $/*result*)

             (T/trx '(long? unix-timestamp)
                    {:description "Unix timestamp returned."})

             (T/group '((T/path.conj 'iso-conversion)
                        
                        ($.time/!.unix->iso unix-timestamp)
                        (def iso-string
                             $/*result*)

                        (T/trx '(str? iso-string)
                               {:description "Conversion looks like an ISO string."})

                        ($.time/!.iso->unix iso-string)
                        (T/trx '(= $/*result*
                                   unix-timestamp)
                               {:description "Converting to a Unix timestamp."}))))))


;;;


(defn suite.main

  ^{:doc {:description "Main test suite."}}

  []

  (T/group '((T/path.conj 'convex.shell.time)
             (suite.advance)
             (suite.unix))))


;;;


(suite.main)
(T/print "convex.shell.time")

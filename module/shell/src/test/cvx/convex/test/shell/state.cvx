;;
;;
;; Testing `convex.shell.state`.
;;
;;


;;;;;;;;;;


(def T
     $.test)


;;;;;;;;;; Test suites


(defn suite.atomic

  ^{:doc {:description "Restoring state on failure."}}

  []

  (T/group '((T/path.conj 'atomic)

             (T/group '((T/path.conj 'success)
                        (def foo
                             42)
                        'last-result-sym
                        ($.state/!.atomic '((def last-result
                                                 $/*result*)
                                            (def foo
                                                 (inc foo))
                                            [last-result foo]))
                        (T/trx '(= $/*result*
                                   ['last-result-sym 43])
                               {:description "Success and last result was accessible."})
                        (T/trx '(= foo
                                   43)
                               {:description "`foo` has been altered."})))

             (T/group '((T/path.conj 'failure)
                        (def foo
                             42)
                        'last-result-sym
                        (T/fail (fn [ex]
                                  (and (= (ex :code)
                                          :FROM-ATOMIC)
                                       (= (ex :message)
                                          ['last-result-sym 43])))
                                '($.state/!.atomic '((def last-result
                                                          $/*result*)
                                                     (def foo
                                                          (inc foo))
                                                     (fail :FROM-ATOMIC
                                                           [last-result foo])))
                                {:description "Exception is rethrown."})
                        (T/trx '(= foo
                                   42)
                               {:description "State has been restored."}))))))



(defn suite.load

  ^{:doc {:description ["Loading a state."]}}

  []

  (T/group '((T/path.conj 'convex.shell.state)

             (T/group '((T/path.conj 'load)

                        'some-result
                        ($.state/!.load-continue *state*)
                        (T/trx '(= $/*result*
                                   'some-result)
                               {:descriptionl "`!.load-continue` preserves the last result."})

                        (def a
                             1)

                        (def s
                             *state*)

                        (def b
                             2)

                        ($.state/!.load-continue s
                                                 `(def c
                                                       ~(inc b)))

                        (T/trx '(= $/*result*
                                   3)
                               {:description "Result matches provided transaction."})

                        (T/trx '(= a
                                   1)
                               {:description "`a` is still present."})

                        (T/trx '(not (defined? b))
                               {:description "`b` was not present before saving the state."})

                        (T/trx '(= c
                                   3)
                               {:description "`c` is the result from executing the given transaction."})))

             (T/group '((T/path.conj 'load-with-genesis-state)

                        [:cvm.sreq :dev.genesis-state]

                        ($.state/!.load-continue $/*result*
                                                 `(def s
                                                       (quote ~*state*)))

                        $
                        ($.state/!.load-continue s
                                                 $/*result*)

                        (T/trx '(= $/*result*
                                   $)
                               {:description "It looks like libraries were deployed while loading the genesis state"}))))))



(defn suite.tmp

  ^{:doc {:description "Executing transactions but only remembering the last result."}}

  []

  (T/group '((T/path.conj 'tmp)

             (def foo
                  42)

             (T/group '((T/path.conj 'success)
                        'last-result-sym
                        ($.state/!.tmp '((def last-result
                                              $/*result*)
                                         (def foo
                                              (inc foo))
                                         (def bar
                                              (inc foo))
                                         [last-result (inc bar)]))
                        (def result
                             $/*result*)
                        (T/trx '(= (first result)
                                   'last-result-sym)
                               {:description "Access to the last result."})
                        (T/trx '(= (second result)
                                   45)
                               {:description "Computation based on `foo` is correct."})
                        (T/trx '(= foo
                                   42)
                               {:description "`foo` remains unchanged."})
                        (T/trx '(not (defined? bar))
                               {:description "`bar` does not exist anymore."})))

             (T/group '((T/path.conj 'failure)
                        'last-result-sym
                        (T/fail (fn [ex]
                                  (and (= (ex :code)
                                          :FROM-TMP-STATE)
                                       (= (ex :message)
                                          ['last-result-sym 43])))
                                '($.state/!.tmp '((def last-result
                                                       $/*result*)
                                                  (def foo
                                                       (inc foo))
                                                  (fail :FROM-TMP-STATE
                                                        [last-result foo])))
                                {:description "Exception is rethrown."})
                        (T/trx '(= foo
                                   42)
                               {:description "`foo` remains unchanged."}))))))



(defn suite.tmp-with

  ^{:doc {:description "Executing transactions with a temporary state."}}

  []

  (T/group '((T/path.conj 'tmp.with)
             
             [:cvm.sreq :dev.genesis-state]
             (def gs
                  $/*result*)

             (T/group '((T/path.conj 'success)
                        'last-result-sym
                        ($.state/!.tmp-with gs
                                            '([$/*result* (defined? gs)]))
                        (T/trx '(= $/*result*
                                   ['last-result-sym false])
                               {:description "Input state was successfully loaded with access to the last result."})
                        (T/trx '(defined? gs)
                               {:description "Original state restored."})))

             (T/group '((T/path.conj 'failure)
                        'last-result-sym
                        (T/fail (fn [ex]
                                  (and (= (ex :code)
                                          :FROM-TMP-STATE)
                                       (= (ex :message)
                                          ['last-result-sym false])))
                                '($.state/!.tmp-with gs
                                                     '((fail :FROM-TMP-STATE
                                                             [$/*result* (defined? gs)])))
                                {:description "Exception rethrown."})
                        (T/trx '(defined? gs)
                               {:description "Original state restored."}))))))


;;;


(defn suite.main

  ^{:doc {:description "Suite gathering all other suites."}}

  []

  (T/group '((T/path.conj 'convex.shell.state)
             (suite.load)
             ;; Higher-level constructs based on state loading.
             (suite.atomic)
             (suite.tmp)
             (suite.tmp-with))))

;;;


(suite.main)
(T/print "convex.shell.state")
